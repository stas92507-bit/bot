<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤–æ–¥—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #45c4e6, #32e6aa 80%, #4f8cfb 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Verdana, sans-serif;
      color: #094e68; padding: 0; margin: 0;
    }
    .container { max-width: 470px; margin: 30px auto 0 auto; background: rgba(255,255,255,0.95);
      border-radius: 22px; box-shadow: 0 6px 24px #0bc7b533; padding: 23px 12px 18px 12px;}
    h2 { text-align: center; color: #1287a8; font-weight: 700; margin-bottom: 9px; }
    .formbox, .filterbox {background: #e7fefb; padding:10px 10px 7px 10px; border-radius:12px; margin-bottom: 12px;}
    .formbox h3,  .filterbox h3 {margin: 0 0 8px 0; font-size:17px; color:#0ab3ad;}
    .row {display:flex; gap:7px; margin-bottom:6px; flex-wrap:wrap;}
    input[type='number'], input[type='date'], input[type='text'] {
      border-radius:7px; border:1px solid #49b8b9; padding:6px 7px; font-size:15px; outline:none;
    }
    button, .btn { font-size: 15px; font-weight: bold; margin-right:6px; cursor:pointer;transition:.1s;}
    .formbox button, .filterbox button {padding: 7px 13px;font-size:13px;}
    button:active, .btn:active {filter: brightness(0.93);}
    .actions {display: flex; justify-content: flex-end; margin-bottom: 4px;}
    .sidebtn {font-size:13px; padding:7px 15px;}
    .chartbox { margin:14px 0 18px 0; background: #e8faf6; border-radius: 14px; padding: 10px 4px; box-shadow: 0 2px 10px #62e6c144;}
    table { width:100%; margin-top:6px;}
    th,td {text-align:center; padding: 4px 0; font-size:13px;}
    th {color:#138c7c;}
    .empty {text-align:center; margin:15px 0; color: #08956a;}
    .closebtn { margin-top:22px; width: 100%; font-size: 17px;}
    #todayNums {display:flex; justify-content: center; gap:36px; margin: 18px 0 10px 0;}
    #todayNums .numblock {text-align:center;}
    #todayNums .numlabel {color:#27a1fd;font-size:13px;}
    #todayNums .numlabel.after {color:#22be9e;}
    #todayNums .num {font-size:33px;padding:7px 0;color:#1b34a6;font-weight: bold;}
    #todayNums .num.after {color:#0d946d;}
  </style>
</head>
<body>
  <div class="container">
    <h2>üíß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤–æ–¥—ã</h2>

    <div class="formbox">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä –≤–æ–¥—ã</h3>
      <form id="addWaterForm" class="row">
        <input id="date" type="date" required>
        <input id="before" type="number" min="1" max="5000" placeholder="–î–æ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)" required>
        <input id="after" type="number" min="0" max="5000" placeholder="–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)" required>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä</button>
      </form>
    </div>

    <div class="filterbox">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</h3>
      <form id="addFilterForm" class="row">
        <input id="filterName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞" required>
        <input id="filterStart" type="date" required>
        <input id="filterEnd" type="date" required>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
      </form>
    </div>

    <div class="actions">
      <button class="sidebtn" onclick="clearAllData();">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>

    <!-- –ö—Ä—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è -->
    <div id="todayNums">
      <div class="numblock">
        <div class="numlabel">–î–æ —Ñ–∏–ª—å—Ç—Ä–∞</div>
        <div id="numBefore" class="num">‚Äî</div>
      </div>
      <div class="numblock">
        <div class="numlabel after">–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞</div>
        <div id="numAfter" class="num after">‚Äî</div>
      </div>
    </div>

    <div class="chartbox"><canvas id="waterChart"></canvas></div>
    <div class="chartbox"><canvas id="filterChart"></canvas></div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è -->
    <div class="chartbox" id="todayChartBox" style="display:none;">
      <h4 style="margin:0 0 7px 0;text-align:center;color:#099;">–°–µ–≥–æ–¥–Ω—è: –≥—Ä–∞—Ñ–∏–∫</h4>
      <canvas id="todayChart"></canvas>
      <div id="todayNoData" style="color:#ca0;text-align:center;display:none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è.</div>
    </div>

    <h3 style="color:#087d81;font-size:16px;margin-top:15px;margin-bottom:4px;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–æ–≤</h3>
    <table>
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–î–æ (ppm)</th>
          <th>–ü–æ—Å–ª–µ (ppm)</th>
          <th>–≠—Ñ—Ñ. (%)</th>
        </tr>
      </thead>
      <tbody id="dataRows"></tbody>
    </table>
    <div class="empty" id="noDataRow" style="display:none;">–ù–µ—Ç –∑–∞–º–µ—Ä–æ–≤ –≤–æ–¥—ã.</div>
      
    <div style="margin-top:18px;">
      <h3 style="color:#087d81;font-size:15px;margin-bottom:3px;">–§–∏–ª—å—Ç—Ä—ã</h3>
      <table>
        <thead>
        <tr>
          <th>–§–∏–ª—å—Ç—Ä</th>
          <th>–°—Ä–æ–∫ (–¥–Ω–µ–π)</th>
          <th>–°—Ä.—ç—Ñ—Ñ. (%)</th>
        </tr>
        </thead>
        <tbody id="filtersRows"></tbody>
      </table>
      <div class="empty" id="noFilterRow" style="display:none;">–ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤</div>
    </div>
    <button class="closebtn" onclick="Telegram.WebApp.close();">–ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
  </div>
  
  <script>
    // --- –†–∞–±–æ—Ç–∞ —Å –∑–∞–º–µ—Ä–∞–º–∏ –≤–æ–¥—ã ---
    function getWaterData() {
      return JSON.parse(localStorage.getItem('water_data') || '[]');
    }
    function saveWaterData(arr) {
      localStorage.setItem('water_data', JSON.stringify(arr));
    }
    function addMeasurement(date, before, after) {
      let arr = getWaterData();
      arr.push({date, before, after});
      arr = arr.sort((a,b)=>a.date.localeCompare(b.date));
      saveWaterData(arr);
    }

    // --- –†–∞–±–æ—Ç–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ ---
    function getFilters() {
      return JSON.parse(localStorage.getItem('filters_list') || '[]');
    }
    function saveFilters(x) {
      localStorage.setItem('filters_list', JSON.stringify(x));
    }
    function addFilter(name, start, end) {
      let arr = getFilters();
      arr.push({name, start, end});
      arr = arr.sort((a,b)=>a.start.localeCompare(b.start));
      saveFilters(arr);
    }
    function clearAllData() {
      localStorage.removeItem('water_data');
      localStorage.removeItem('filters_list');
      window.location.reload();
    }

    // --- –ö—Ä—É–ø–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –¥–Ω—è
    function updateTodayNums() {
      const data = getWaterData();
      const todayStr = new Date().toISOString().slice(0,10);
      const todayEntry = data.find(d => d.date === todayStr);
      document.getElementById('numBefore').innerText = todayEntry ? todayEntry.before : "‚Äî";
      document.getElementById('numAfter').innerText = todayEntry ? todayEntry.after : "‚Äî";
    }

    // --- –ì–†–ê–§–ò–ö–ò ---
    let waterChartInst, filterChartInst;
    function drawCharts() {
      const data = getWaterData();
      const days = data.map(d => d.date && d.date.split('-').reverse().join('.'));
      const before = data.map(d => d.before);
      const after = data.map(d => d.after);
      const effect = data.map((d, i)=>d.before > 0 ? Math.round((1-d.after/d.before)*100) : 0);

      if(!waterChartInst) {
        waterChartInst = new Chart(document.getElementById('waterChart').getContext('2d'), {
          type: 'line',
          data: { labels: days, datasets: [
            { label: '–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data: after, fill:true, borderColor:'#3ac8f7', backgroundColor:'rgba(54, 240, 247, 0.17)', pointBackgroundColor:'#17fa96', tension:0.38, order:2 },
            { label: '–î–æ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data: before, fill:false, borderColor:'#0addb7', backgroundColor:'#d0fff0', pointBackgroundColor:'#1ad1a9', tension:0.30, borderDash:[6,6], order:1 }
          ]},
          options: { plugins: {
            title:{ display:true, text:'–ü–æ–∫–∞–∑–∞–Ω–∏—è –≤–æ–¥—ã', color:'#138c7c', font:{weight:'bold',size:17} },
            legend:{labels:{color:'#1287a8'}}
          },
          scales: { y: { beginAtZero:true, color: '#1287a8', grid: {color:'#baf5ea'}, suggestedMax:500 }, x: {ticks:{color:'#1287a8'}} }
        }});
      } else {
        waterChartInst.data.labels = days;
        waterChartInst.data.datasets[0].data = after;
        waterChartInst.data.datasets[1].data = before;
        waterChartInst.update();
      }

      if(!filterChartInst) {
        filterChartInst = new Chart(document.getElementById('filterChart').getContext('2d'), {
          type: 'bar',
          data: { labels:days, datasets: [
            { label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (%)', data:effect, backgroundColor:'#17fa96', borderRadius:7 }
          ]},
          options: { plugins: {
            title:{ display:true, text:'–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞', color:'#1d858b', font:{weight:'bold',size:17} },
            legend:{display:false}
          }, 
          scales: {y:{beginAtZero:true,max:100, color:'#08956a', grid:{color:'#cafef8'}}, x:{ticks:{color:'#08956a'}} }
        }});
      } else {
        filterChartInst.data.labels = days;
        filterChartInst.data.datasets[0].data = effect;
        filterChartInst.update();
      }
    }

    // --- –ì–†–ê–§–ò–ö –ó–ê –°–ï–ì–û–î–ù–Ø ---
    function drawTodayChart() {
      const data = getWaterData();
      const todayStr = new Date().toISOString().slice(0,10);
      const todayEntry = data.find(d => d.date === todayStr);
      const todayBox = document.getElementById('todayChartBox');
      const noDataDiv = document.getElementById('todayNoData');
      if (!todayEntry) {
        todayBox.style.display = 'block';
        document.getElementById('todayChart').style.display = 'none';
        noDataDiv.style.display = 'block';
        return;
      }
      todayBox.style.display = 'block';
      noDataDiv.style.display = 'none';
      document.getElementById('todayChart').style.display = 'block';
      if (window.todayChartInst) { window.todayChartInst.destroy(); }
      window.todayChartInst = new Chart(document.getElementById('todayChart').getContext('2d'), {
        type: 'bar',
        data: {labels: ['–î–æ', '–ü–æ—Å–ª–µ'], datasets: [
          {label: 'ppm', data: [todayEntry.before, todayEntry.after], backgroundColor:['#2BAFE8','#36EAA9']}
        ]},
        options: {
          plugins: {title:{display:false}},
          scales: {y:{beginAtZero:true,suggestedMax:500,color:'#087d81'}}
        }
      });
    }

    // --- –í–´–í–û–î –î–ê–ù–ù–´–• ---
    function renderAll() {
      const data = getWaterData();
      const table = document.getElementById('dataRows');
      table.innerHTML = "";
      if(!data.length) {
        document.getElementById('      ftable.innerHTML = '';
      if (!filters.length) {
        document.getElementById('noFilterRow').style.display='block';
      } else {
        document.getElementById('noFilterRow').style.display='none';
        filters.forEach(filter => {
          const start = filter.start, end = filter.end;
          const days = Math.round((new Date(end)-new Date(start))/(24*60*60*1000))+1;
          const filData = data.filter(d => d.date >= start && d.date <= end);
          let eff = filData.length ? Math.round(
            filData.map(d => 100*(1-d.after/d.before))
                  .reduce((a,b)=>a+b,0) / filData.length
            ) : 0;
          ftable.innerHTML += `<tr>
            <td>${filter.name}</td>
            <td>${days}</td>
            <td>${          </tr>`;
        });
      }
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º ---
    document.getElementById('addWaterForm').onsubmit = ev => {
      ev.preventDefault();
      let date = document.getElementById('date').value;
      let before = parseInt(document.getElementById('before').value);
      let after = parseInt(document.getElementById('after').value);
      if (!date || isNaN(before)|| isNaN(after)) return;
      addMeasurement(date, before, after);
      renderAll();
      ev.target.reset();
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
    }
    document.getElementById('addFilterForm').onsubmit = ev => {
      ev.preventDefault();
      let name = document.getElementById('filterName').value;
      let start = document.getElementById('filterStart').value;
      let end = document.getElementById('filterEnd').value;
      if (!name || !start || !end) return;
      addFilter(name, start, end);
      renderAll();
      ev.target.reset();
    }

    window.onload = ()=>{
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
      renderAll();
    }
  </script>
</body>
</html>
