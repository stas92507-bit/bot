<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–¥—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #45c4e6, #32e6aa 80%, #4f8cfb 100%);
      min-height: 100vh; font-family: 'Segoe UI', Verdana, sans-serif;
      color: #094e68; padding: 0; margin: 0;
    }
    .container { max-width: 420px; margin: 36px auto 0 auto; background: rgba(255,255,255,0.86);
      border-radius: 22px; box-shadow: 0 6px 24px #0bc7b533; padding: 28px 12px 18px 12px;}
    h2 { text-align: center; color: #1287a8; font-weight: 700; margin-bottom: 9px; }
    .chartbox { margin:18px 0; background: #e8faf6; border-radius: 14px; padding: 10px 4px; box-shadow: 0 2px 10px #62e6c144;}
    table { width:100%; margin-top:10px;}
    td,th {text-align:center; padding: 5px 0;}
    th {color:#138c7c;}
    .empty {text-align:center; margin:18px 0;}
    button {margin-top:20px; width:100%; background: linear-gradient(90deg, #2ee7ff 0, #7afe97 80%);
      color: #044c54; font-size: 17px; padding: 14px; border-radius: 16px; border: none;
      font-weight: 700; box-shadow: 0 2px 8px #46e7be33; cursor:pointer; transition:.1s;}
    button:active {filter:brightness(0.92);}
  </style>
</head>
<body>
  <div class="container">
    <h2>üíß–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã<br><span style="font-size:14px;font-weight:400;color:#1ca289">–¥–∞–Ω–Ω—ã–µ —Å–æ —Å–∫–≤–∞–∂–∏–Ω—ã</span></h2>
    <div class="chartbox"><canvas id="waterChart"></canvas></div>
    <div class="chartbox"><canvas id="filterChart"></canvas></div>
    <table border="0">
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–î–æ (ppm)</th>
          <th>–ü–æ—Å–ª–µ (ppm)</th>
          <th>–≠—Ñ—Ñ–µ–∫—Ç. (%)</th>
        </tr>
      </thead>
      <tbody id="dataRows"></tbody>
    </table>
    <div class="empty" id="noDataRow" style="display:none;">–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
    <button onclick="Telegram.WebApp.close();">–ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
  </div>
  
  <script>
    const DATA_API_URL = "https://–≤–∞—à_—Å–µ—Ä–≤–µ—Ä/data.json"; // <-- –£–∫–∞–∂–∏—Ç–µ —Ç—É—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
    let waterChartInst, filterChartInst;
    async function loadData() {
      document.getElementById('noDataRow').style.display = 'none';
      let data = [];
      try {
        const response = await fetch(DATA_API_URL);
        data = await response.json();
      } catch (e) {
        document.getElementById('noDataRow').style.display = 'block';
        return;
      }
      // –¢–∞–±–ª–∏—Ü–∞:
      const table = document.getElementById('dataRows');
      table.innerHTML = "";
      if (!data.length) {
        document.getElementById('noDataRow').style.display = 'block';
      } else {
        data.forEach(d => {
          let effect = d.before > 0 ? Math.round((1-d.after/d.before)*100) : 0;
          table.innerHTML += `<tr>
            <td>${d.date.split('-').reverse().join('.')}</td>
            <td>${d.before}</td>
            <td>${d.after}</td>
            <td>${effect}</td>
          </tr>`;
        });
      }
      // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:
      const days = data.map(d => d.date.split('-').reverse().join('.'));
      const before = data.map(d => d.before);
      const after = data.map(d => d.after);
      const effect = data.map((d, i)=>d.before > 0 ? Math.round((1-d.after/d.before)*100) : 0);

      // –ü–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫: –ø–æ—Å–ª–µ/–¥–æ —Ñ–∏–ª—å—Ç—Ä–∞
      if(!waterChartInst) {
        waterChartInst = new Chart(document.getElementById('waterChart').getContext('2d'), {
          type: 'line',
          data: { labels: days, datasets: [
            { label: '–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data: after, fill:true, borderColor:'#3ac8f7', backgroundColor:'rgba(54, 240, 247, 0.17)', pointBackgroundColor:'#17fa96', tension:0.38, order:2 },
            { label: '–î–æ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data: before, fill:false, borderColor:'#0addb7', backgroundColor:'#d0fff0', pointBackgroundColor:'#1ad1a9', tension:0.29, borderDash:[6,6], order:1 }
          ]},
          options: { plugins: {
            title:{ display:true, text:'–ü–æ–∫–∞–∑–∞–Ω–∏—è –≤–æ–¥—ã', color:'#138c7c', font:{weight:'bold',size:17} },
            legend:{labels:{color:'#1287a8'}}
          },
          scales: { y: { beginAtZero:true, color: '#1287a8', grid: {color:'#baf5ea'} },
                    x: {ticks:{color:'#1287a8'}} }
        }});
      } else {
        waterChartInst.data.labels = days;
        waterChartInst.data.datasets[0].data = after;
        waterChartInst.data.datasets[1].data = before;
        waterChartInst.update();
      }

      // –í—Ç–æ—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      if(!filterChartInst) {
        filterChartInst = new Chart(document.getElementById('filterChart').getContext('2d'), {
          type: 'bar',
          data: { labels:days, datasets: [
            { label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (%)', data:effect, backgroundColor:'#17fa96', borderRadius:7 }
          ]},
          options: { plugins: {
            title:{ display:true, text:'–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞', color:'#1d858b', font:{weight:'bold',size:17} },
            legend:{display:false}
          }, 
          scales: {y:{beginAtZero:true,max:100, color:'#08956a', grid:{color:'#cafef8'}}, x:{ticks:{color:'#08956a'}} }
        }});
      } else {
        filterChartInst.data.labels = days;
        filterChartInst.data.datasets[0].data = effect;
        filterChartInst.update();
      }
    }
    window.onload = loadData;
  </script>
</body>
</html>
