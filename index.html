<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–¥—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #45c4e6, #32e6aa 80%, #4f8cfb 100%);
      min-height: 100vh; font-family: 'Segoe UI', Verdana, sans-serif;
      color: #094e68; padding: 0; margin: 0;
    }
    .container { max-width: 460px; margin: 36px auto 0 auto; background: rgba(255,255,255,0.90);
      border-radius: 22px; box-shadow: 0 6px 24px #0bc7b533; padding: 28px 12px 18px 12px;}
    h2 { text-align: center; color: #1287a8; font-weight: 700; margin-bottom: 9px; }
    .actions {display: flex; gap: 10px; justify-content: space-between;}
    .chartbox { margin:18px 0; background: #e8faf6; border-radius: 14px; padding: 10px 4px; box-shadow: 0 2px 10px #62e6c144;}
    table { width:100%; margin-top:10px;}
    td, th {text-align:center; padding: 5px 0;}
    th {color:#138c7c;}
    .empty {text-align:center; margin:18px 0;}
    button {background: linear-gradient(90deg, #2ee7ff 0, #49ffea 80%); color: #044c54; font-size: 14px; padding: 10px 12px;
      border-radius: 10px; border: none; font-weight: 700; cursor:pointer; box-shadow: 0 2px 8px #46e7be33; transition:.1s;}
    button:active {filter:brightness(0.92);}
    .closebtn { margin-top:22px; width: 100%; font-size: 17px;}
    .sidebtn {font-size:13px; padding:7px 16px;}
    .filters-list {margin-top:30px;}
    .filters-list h3 {font-size:17px; color:#087d81; margin-bottom:5px;}
    .filters-table th {font-size:14px;}
    .filters-table td {font-size:13px;}
  </style>
</head>
<body>
  <div class="container">
    <h2>üíß–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
    
    <div class="actions">
      <span></span>
      <button class="sidebtn" onclick="clearData();">–°–±—Ä–æ—Å–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏</button>
    </div>
    <div class="chartbox"><canvas id="waterChart"></canvas></div>
    <div class="chartbox"><canvas id="filterChart"></canvas></div>
    <table border="0">
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–î–æ (ppm)</th>
          <th>–ü–æ—Å–ª–µ (ppm)</th>
          <th>–≠—Ñ—Ñ–µ–∫—Ç. (%)</th>
        </tr>
      </thead>
      <tbody id="dataRows"></tbody>
    </table>
    <div class="empty" id="noDataRow" style="display:none;">–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</div>
    
    <div class="filters-list">
      <h3>–¢–∞–±–ª–∏—Ü–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤</h3>
      <table class="filters-table" border="0">
        <thead>
          <tr>
            <th>–§–∏–ª—å—Ç—Ä</th>
            <th>–°—Ä–æ–∫ —Å–ª—É–∂–±—ã (–¥–Ω–µ–π)</th>
            <th>–°—Ä–µ–¥–Ω. —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (%)</th>
          </tr>
        </thead>
        <tbody id="filtersRows">
          <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </tbody>
      </table>
    </div>
    <button class="closebtn" onclick="Telegram.WebApp.close();">–ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
  </div>
  
  <script>
    // –ê–¥—Ä–µ—Å, –æ—Ç–∫—É–¥–∞ –∑–∞–±–∏—Ä–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ (–º–∞—Å—Å–∏–≤ –∑–∞–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤–∞—à–∞ –ê—Ä–¥—É–∏–Ω–æ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä)
    const DATA_API_URL = "https://–≤–∞—à_—Å–µ—Ä–≤–µ—Ä/data.json"; // –£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å —Å–≤–æ–µ–π API

    // –°–∏–º—É–ª—è—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
    let filtersMeta = [
      {name: "–ì–µ–π–∑–µ—Ä –ë–ò–û", start: "2024-05-10", end: "2024-06-01"},
      {name: "–ë–∞—Ä—å–µ—Ä –°—Ç–∞–Ω–¥–∞—Ä—Ç", start: "2024-06-02", end: "2024-06-20"},
    ];
    // –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–¥ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –¥–∞—Ç—ã

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    let waterChartInst, filterChartInst;
    let currentData = [];

    // --- –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Local Storage –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä!)
    function clearData() {
      localStorage.removeItem('water_cache');
      location.reload();
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–∫—ç—à–∏—Ä—É–µ–º –Ω–∞ 1 –º–∏–Ω)
    async function loadData() {
      document.getElementById('noDataRow').style.display = 'none';
      let data = [];
      let fromCache = false;
      try {
        // (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
        const stored = localStorage.getItem('water_cache');
        const storeTime = localStorage.getItem('water_cache_time');
        const now = Date.now();
        if (stored && storeTime && now - Number(storeTime) < 60000) {
          data = JSON.parse(stored);
          fromCache = true;
        } else {
          const response = await fetch(DATA_API_URL);
          data = await response.json();
          localStorage.setItem('water_cache', JSON.stringify(data));
          localStorage.setItem('water_cache_time', now.toString());
        }
      } catch (e) {
        document.getElementById('noDataRow').style.display = 'block';
        // –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫–∏ —Ç–æ–∂–µ —Å—Ç—Ä–æ–∏–ª–∏—Å—å (–ø—É—Å—Ç—ã–º–∏)
      }
      currentData = Array.isArray(data) ? data : [];
      renderAll();
    }

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ---
    function renderAll() {
      // --- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ—Ä–æ–≤ ---
      const data = currentData;
      const table = document.getElementById('dataRows');
      table.innerHTML = "";
      if(!data.length) {
        document.getElementById('noDataRow').style.display = 'block';
      } else {
        document.getElementById('noDataRow').style.display = 'none';
        data.forEach(d => {
          let effect = d.before > 0 ? Math.round((1-d.after/d.before)*100) : 0;
          table.innerHTML += `<tr>
            <td>${d.date && d.date.split('-').reverse().join('.')}</td>
            <td>${d.before ?? ""}</td>
            <td>${d.after ?? ""}</td>
            <td>${effect}</td>
          </tr>`;
        });
      }
      // –ì—Ä–∞—Ñ–∏–∫–∏
      drawCharts(data);

      // –¢–∞–±–ª–∏—Ü–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø—Ä–∏–º–µ—Ä: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º, –µ—Å–ª–∏ –µ—Å—Ç—å)
      renderFiltersTable(data);
    }

    // --- –ì—Ä–∞—Ñ–∏–∫–∏ ---
    function drawCharts(data) {
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∏—Å—É–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
      const days = data.map(d => d.date && d.date.split('-').reverse().join('.'));
      const before = data.map(d => d.before);
      const after = data.map(d => d.after);
      const effect = data.map((d, i)=>d.before > 0 ? Math.round((1-d.after/d.before)*100) : 0);

      if(!waterChartInst) {
        waterChartInst = new Chart(document.getElementById('waterChart').getContext('2d'), {
          type: 'line',
          data: { labels: days, datasets: [
            { label: '–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data: after, fill:true, borderColor:'#3ac8f7', backgroundColor:'rgba(54, 240, 247, 0.17)', pointBackgroundColor:'#17fa96', tension:0.38, order:2 },
            { label: '–î–æ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data: before, fill:false, borderColor:'#0addb7', backgroundColor:'#d0fff0', pointBackgroundColor:'#1ad1a9', tension:0.29, borderDash:[6,6], order:1 }
          ]},
          options: { plugins: {
            title:{ display:true, text:'–ü–æ–∫–∞–∑–∞–Ω–∏—è –≤–æ–¥—ã', color:'#138c7c', font:{weight:'bold',size:17} },
            legend:{labels:{color:'#1287a8'}}
          },
          scales: { y: { beginAtZero:true, color: '#1287a8', grid: {color:'#baf5ea'}, suggestedMax:500 }, x: {ticks:{color:'#1287a8'}} }
        }});
      } else {
        waterChartInst.data.labels = days;
        waterChartInst.data.datasets[0].data = after;
        waterChartInst.data.datasets[1].data = before;
        waterChartInst.update();
      }
      if(!filterChartInst) {
        filterChartInst = new Chart(document.getElementById('filterChart').getContext('2d'), {
          type: 'bar',
          data: { labels:days, datasets: [
            { label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (%)', data:effect, backgroundColor:'#17fa96', borderRadius:7 }
          ]},
          options: { plugins: {
            title:{ display:true, text:'–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞', color:'#1d858b', font:{weight:'bold',size:17} },
            legend:{display:false}
          }, 
          scales: {y:{beginAtZero:true,max:100, color:'#08956a', grid:{color:'#cafef8'}}, x:{ticks:{color:'#08956a'}} }
        }});
      } else {
        filterChartInst.data.labels = days;
        filterChartInst.data.datasets[0].data = effect;
        filterChartInst.update();
      }
    }

    // --- –¢–∞–±–ª–∏—Ü–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ ---
    function renderFiltersTable(data) {
      const tbody = document.getElementById('filtersRows');
      tbody.innerHTML = "";
      // –í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ ‚Äî —Ñ–∏–ª—å—Ç—Ä –º–µ–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –ø–æ –¥–∞—Ç–∞–º. –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥ –≤–∞—à–∏ API!
      filtersMeta.forEach(filter => {
        // –†–∞—Å—á—ë—Ç —Å—Ä–æ–∫–∞ —Å–ª—É–∂–±—ã —ç—Ç–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞:
        const start = filter.start, end = filter.end;
        const days = Math.round((new Date(end)-new Date(start))/(24*60*60*1000))+1;
        // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–º–µ—Ä—ã, —á—Ç–æ –ø–æ–ø–∞–ª–∏ –≤ —Å—Ä–æ–∫ —ç—Ç–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
        const filData = data.filter(d => d.date >= start && d.date <= end);
        // –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        let eff = filData.length ? Math.round(
          filData.map(d => 100*(1-d.after/d.before))
                .reduce((a,b)=>a+b,0) / filData.length
          ) : 0;
        tbody.innerHTML += `<tr>
          <td>${filter.name}</td>
          <td>${days}</td>
          <td>${eff}</td>
        </tr>`;
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>
