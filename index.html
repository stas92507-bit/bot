<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–¥—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #45c4e6, #32e6aa 80%, #4f8cfb 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Verdana, sans-serif;
      color: #094e68; padding: 0; margin: 0;
    }
    .container {
      max-width: 420px; margin: 36px auto 0 auto;
      background: rgba(255,255,255,0.86);
      border-radius: 22px; box-shadow: 0 6px 24px #0bc7b533;
      padding: 28px 12px 18px 12px;
    }
    h2 { text-align: center; color: #1287a8; font-weight: 700; margin-bottom: 9px; }
    form { display: flex; gap: 6px; margin-bottom: 22px; flex-wrap: wrap; align-items:end; background: #3daeae11; border-radius:14px; padding:7px 10px;}
    form input[type=number] { width: 82px; border-radius: 7px; padding: 6px 7px; border: 1px solid #45c4e6; margin-right: 6px; font-size: 15px;}
    form button { background: linear-gradient(90deg, #2ee7ff 0, #7afe97 80%); color: #044c54; font-size: 14px; padding: 10px 12px; border-radius: 10px; border: none; font-weight: 700; cursor:pointer;}
    .chartbox { margin:18px 0; background: #e8faf6; border-radius: 14px; padding: 10px 4px; box-shadow: 0 2px 10px #62e6c144;}
    table { width:100%; margin-top:10px;}
    td,th {text-align:center; padding: 5px 0;}
    th {color:#138c7c;}
    .empty {text-align:center; margin:18px 0;}
    button.closebtn {margin-top:20px;}
  </style>
</head>
<body>
  <div class="container">
    <h2>üíß–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã<br><span style="font-size:14px;font-weight:400;color:#1ca289">–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —É—á—ë—Ç</span></h2>
    <form id="addForm">
      <input type="date" id="date" required value="">
      <input type="number" min="1" max="5000" placeholder="–î–æ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)" id="before" required>
      <input type="number" min="0" max="5000" placeholder="–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)" id="after" required>
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    <div class="chartbox"><canvas id="waterChart"></canvas></div>
    <div class="chartbox"><canvas id="filterChart"></canvas></div>

    <table border="0">
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–î–æ</th>
          <th>–ü–æ—Å–ª–µ</th>
          <th>–≠—Ñ—Ñ–µ–∫—Ç., %</th>
        </tr>
      </thead>
      <tbody id="dataRows"></tbody>
    </table>
    <div class="empty" id="noDataRow" style="display:none;">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ!</div>
    <button class="closebtn" onclick="Telegram.WebApp.close();">–ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
  </div>
  
  <script>
    // --- –†–∞–±–æ—Ç–∞–µ–º —Å localStorage ---
    function getWaterData() {
      return JSON.parse(localStorage.getItem('water_data') || '[]');
    }
    function saveWaterData(arr) {
      localStorage.setItem('water_data', JSON.stringify(arr));
    }
    function addMeasurement(date, before, after) {
      let arr = getWaterData();
      arr.push({date, before, after});
      arr = arr.sort((a,b)=>a.date.localeCompare(b.date));
      saveWaterData(arr);
    }

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏–π –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ ---
    function renderAll() {
      const data = getWaterData();
      const table = document.getElementById('dataRows');
      table.innerHTML = "";
      if(data.length === 0) {
        document.getElementById('noDataRow').style.display = 'block';
      } else {
        document.getElementById('noDataRow').style.display = 'none';
        data.forEach(d => {
          let effect = d.before>0 ? Math.round((1-d.after/d.before)*100) : 0;
          table.innerHTML += `<tr>
            <td>${d.date.split('-').reverse().join('.')}</td>
            <td>${d.before}</td>
            <td>${d.after}</td>
            <td>${effect}</td>
          </tr>`;
        });
      }

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:
      const days = data.map(d=>d.date.split('-').reverse().join('.'));
      const before = data.map(d=>d.before);
      const after = data.map(d=>d.after);
      const effect = data.map((d,i)=>d.before>0 ? Math.round((1-d.after/d.before)*100) : 0);

      // –ü–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫: –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞
      waterChartInst.data.labels = days;
      waterChartInst.data.datasets[0].data = after;
      waterChartInst.data.datasets[1].data = before;
      waterChartInst.update();

      // –í—Ç–æ—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      filterChartInst.data.labels = days;
      filterChartInst.data.datasets[0].data = effect;
      filterChartInst.update();
    }

    // --- –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ---
    document.getElementById('addForm').onsubmit = ev => {
      ev.preventDefault();
      let date = document.getElementById('date').value;
      let before = parseInt(document.getElementById('before').value);
      let after = parseInt(document.getElementById('after').value);
      if (!date || isNaN(before)|| isNaN(after)) return;
      addMeasurement(date, before, after);
      renderAll();
      ev.target.reset();
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
    }

    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å Chart.js ---
    const waterChartInst = new Chart(document.getElementById('waterChart').getContext('2d'), {
      type: 'line',
      data: { labels: [], datasets: [
        { label: '–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data:[], fill:true, borderColor:'#3ac8f7', backgroundColor:'rgba(54, 240, 247, 0.17)', pointBackgroundColor:'#17fa96', tension:0.38, order:2 },
        { label: '–î–æ —Ñ–∏–ª—å—Ç—Ä–∞ (ppm)', data:[], fill:false, borderColor:'#0addb7', backgroundColor:'#d0fff0', pointBackgroundColor:'#1ad1a9', tension:0.29, borderDash:[6,6], order:1 }
      ]},
      options: {
        plugins: {
          title: { display:true, text:'–ü–æ–∫–∞–∑–∞–Ω–∏—è –≤–æ–¥—ã', color:'#138c7c', font:{weight:'bold',size:17} },
          legend: {labels:{color:'#1287a8'}}
        },
        scales: { y: { beginAtZero:true, color: '#1287a8', grid: {color:'#baf5ea'} },
                  x: {ticks:{color:'#1287a8'}} }
      }
    });

    const filterChartInst = new Chart(document.getElementById('filterChart').getContext('2d'), {
      type: 'bar',
      data: { labels:[], datasets:[
        { label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (%)', data:[], backgroundColor:'#17fa96', borderRadius:7 }
      ]},
      options: {
        plugins: { title:{ display:true, text:'–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏', color:'#1d858b', font:{weight:'bold',size:17} }, legend: {display:false} },
        scales: {y:{beginAtZero:true, max:100, color:'#08956a', grid:{color:'#cafef8'}}, x:{ticks:{color:'#08956a'}} }
      }
    });

    // --- –ó–∞–ø—É—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ---
    window.onload = ()=>{
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Ñ–æ—Ä–º—É:
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
      renderAll();
    }
  </script>
</body>
</html>
